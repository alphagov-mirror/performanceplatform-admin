language: python
dist: trusty
python:
  - '2.7'
cache: pip
sudo: true
notifications:
  email: false

services:
  - redis-server

env:
  global:
    - PAAS_USER: pp-deploy@digital.cabinet-office.gov.uk
    - PAAS_SERVICE: performance-platform-admin
    - APP_BACKDROP_HOST_STAGING: https://www.staging.performance.service.gov.uk
    - APP_BACKDROP_HOST_PRODUCTION: https://www.performance.service.gov.uk
    - APP_SIGNON_BASE_URL_STAGING: https://signon.staging.publishing.service.gov.uk
    - APP_SIGNON_BASE_URL_PRODUCTION: https://signon.publishing.service.gov.uk
    - REDIS_DATABASE_NUMBER_STAGING: 2
    - REDIS_DATABASE_NUMBER_PRODUCTION: 3
    - APP_OAUTHLIB_INSECURE_TRANSPORT: 1
    # PAAS_PASSWORD
    - secure: cTNAL8kp9D0jiOqZIU0TNs3Pie7a/ZhTSgt6RoCn7h8yz3FpjPqXZ06VmIL/k5nWTXqlqL3/JNlzeO22k8yGGgydyN5BonD+dZu2F5LMr7ntAzUWt+HSvTc2mefTDX/aw8Thvf8z+ane5CLiGZiqSDRXen+u7QbKG0xEOL7uq9s=
    # APP_SECRET_KEY_STAGING
    - secure: RVfar/tsYGRRLW8I4KFHg/AC30MlAZZe1Q5IL7RawGdCDiS5g1/Cr3IljjQIhFP8lZV3DGp8FiqVZpGno/vogNqUI44MWS5bXNJ7MVagquPGwo6+JDyZWp/92xmUCuQVS7YIN0ZrgGipxkXN+owZbAzTVep6bvLqDcBlGJjD9NA=
    # APP_SECRET_KEY_PRODUCTION
    - secure: jZzOmVCPYiWgjtlC3Y9jYND9o99tZGG4q9cEqO+c39m1YkN8HzHmK61KH3RYK2y4aLk9Dkfg8yK1r3HaW+jT1la4SZ2/t0REDtGAkJoX/tzbFBAXY5Wsk4fCKz9bIDt0eaSTLW1ZQemxnBcJI27/9UvQ5Qr+x2qKKK9Fcl7GKRU=
    # APP_SIGNON_OAUTH_ID_STAGING
    - secure: nk5rRY9OLNuVudlK5HpNtnmP2Jb00UNmwKuLBbp4Aev/WerMIw1Uo3n/31qrNUiwO1DGGARA2WmTpHPEW80Z1/wE9d3Y7KSy4jKyeSZu4G2ZMUWP8O+xXnbrS+Q3u39awiZ3qFx9C04GoaE2TFjvqjvdJgq8owFNrFSLY0+o0U0=
    # APP_SIGNON_OAUTH_ID_PRODUCTION
    - secure: J9oCNYnQXLAaR0mmxSC3qe+ji4o/cxvnodbqb+V7fz4bGgaBga87AbUAIxHTxGiSxFUWQwNUQ4Jz5eSCZ223xslAmwpZZVfmf0deB3/iMa5vBh0OaxQ23AMS1PIhkAReOKBRYK36UcQHb+JS9NbFwX8T6wnW0c6vyVQkkdO0Lww=
    # APP_SIGNON_OAUTH_SECRET_STAGING
    - secure: poqxE9c2aQA2z7t8o3KCqVthPSdLt/dHpmNqgSoxkSyigZEB1vW4InN2Z6Cl0T5eNCsaN+iSNF9u+vn9OvMo/j1tVzg+0a0iVDrIdkiRoGoTv+dCSSY62tW6w/jsFLJreTjM9y1IrYC4C8amxsIe3LWya1uwoXALqOswi95nxcE=
    # APP_SIGNON_OAUTH_SECRET_PRODUCTION
    - secure: EW/bwbqiHPQuTdv1ocTPinad0DdyeXUA2K9K+9VUhPgOn/RG0r1JL3KODcFaFxBxrRj3Tl6/Ilrvr6nH6Krdqg9N5YrRipK6xWf6a4ntbmgU0J3lIXxCZYSTFUNiEeYuLp0LHLE7b5vMrfwhSfbvQPqTdjXZVW9GwSekUgHTIHM=
    # Contains a GH_TOKEN
    - secure: phJDs0lrSnnexBbeEde6Sn5TC4IcXPfjnHdJaSIn9juXg8Ks8K5GZ0HvFwBVsABZTC+ym9xmcRILt0ZUU81k1H9Ol9G2dnwCm+D9uNPzAP4yTxFpaKmfjutRA72K2mN5yS/1JZ3HZ5JZ54mJghyVev+KnIoMv1RsmpAo5hxNpQE=
    # APP_AWS_ACCESS_KEY_ID_STAGING
    - secure: IjkVPhe6OSlLIwNlts0phw6YOzKZjPbwrYWAaVdBTlG198xkg4hXgmo/XtTQmTYsOo91QwfxlhBqY5cxRM6d53osz21rBpwJ9NbZKBgwcbOJLOJoXQjZQgW6TCXmBaiHD4P+Rl7HQAUOCKLMPilrw49/XU7eQoNdzRpOOEdnfhg=
    # APP_AWS_ACCESS_KEY_ID_PRODUCTION
    - secure: R31NJmY0mWBi3A62lCvc7Qk0ZJ28Cpkw8Z43LDB3a6bXFmqtkGsN8RXLvJrSdPq55kNofZ11R/sbkL9/UM0TEln22nX0rdofaVgLij/5SjsFmawPjG4Ldr7OvzywdBtPTGkkGhEp1osOZi4VeIli2KB8mb3oXD9lJ31D/Zh7gSs=
    # APP_AWS_SECRET_ACCESS_KEY_STAGING
    - secure: RuGN1L0dCzy8f/3LBm9GJXxI+dwPawOX1eoSBwl0/rCVQLL59Gdr10z3mj6UoL7DWHucUAwuNhWmlu7SSrEwKyL8BFpn5XOUhqrdkdWnfgjf9MduUC07V4d7OQBcyOcDdpNXWmwIwbPI5ZGmVUQR66c1M8vF0S7QxEIQxhQtGdY=
    # APP_AWS_SECRET_ACCESS_KEY_PRODUCTION
    - secure: MPj13mJJyeYgQ/RN6xL4MkeiYIWI2XflC/sIO5Xu5LaCxFAlVfn4v0OITM9mRb/nxOyQfvJkTkaVstp4dWXQNSZghxnTFY2tYeDLE4/d+oFBlmZbxxbNx+JfQOolglObfrNWTSOoa+d/F59Q6tvS8qo9ERM4U8gvuuibZ44gjuw=

before_install:
  - sudo rm -f /etc/boto.cfg

script:
  - ./run_tests.sh

before_deploy:
  - chmod +x etc/deploy.sh

deploy:
  - provider: script
    script: APP_SECRET_KEY=$APP_SECRET_KEY_STAGING APP_BACKDROP_HOST=$APP_BACKDROP_HOST_STAGING APP_SIGNON_BASE_URL=$APP_SIGNON_BASE_URL_STAGING APP_SIGNON_OAUTH_ID=$APP_SIGNON_OAUTH_ID_STAGING APP_SIGNON_OAUTH_SECRET=$APP_SIGNON_OAUTH_SECRET_STAGING APP_AWS_ACCESS_KEY_ID=$APP_AWS_ACCESS_KEY_ID_STAGING APP_AWS_SECRET_ACCESS_KEY=$APP_AWS_SECRET_ACCESS_KEY_STAGING  REDIS_DATABASE_NUMBER=$REDIS_DATABASE_NUMBER_STAGING etc/deploy.sh staging
    skip_cleanup: true
    on:
      branch: staging

  - provider: script
    script: APP_SECRET_KEY=$APP_SECRET_KEY_PRODUCTION APP_BACKDROP_HOST=$APP_BACKDROP_HOST_PRODUCTION APP_SIGNON_BASE_URL=$APP_SIGNON_BASE_URL_PRODUCTION APP_SIGNON_OAUTH_ID=$APP_SIGNON_OAUTH_ID_PRODUCTION APP_SIGNON_OAUTH_SECRET=$APP_SIGNON_OAUTH_SECRET_PRODUCTION APP_AWS_ACCESS_KEY_ID=$APP_AWS_ACCESS_KEY_ID_PRODUCTION APP_AWS_SECRET_ACCESS_KEY=$APP_AWS_SECRET_ACCESS_KEY_PRODUCTION REDIS_DATABASE_NUMBER=$REDIS_DATABASE_NUMBER_PRODUCTION etc/deploy.sh production
    skip_cleanup: true
    on:
      branch: production
